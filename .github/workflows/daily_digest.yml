name: Daily Dive Conditions

on:
  # Run daily at 5:30 AM Hawaii time (HST = UTC-10, so 15:30 UTC)
  schedule:
    - cron: '30 15 * * *'

  # Allow manual trigger from Actions tab
  workflow_dispatch:

  # Also run on push to main to update GitHub Pages
  push:
    branches:
      - main

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate HTML report
        env:
          OPENWEATHERMAP_API_KEY: ${{ secrets.OPENWEATHERMAP_API_KEY }}
        run: |
          python -c "
          from src.digests.daily_digest import generate_daily_digest
          from src.digests.formatter import format_email_html
          import json

          digest = generate_daily_digest()
          html = format_email_html(digest)

          # Create output directory for GitHub Pages
          import os
          os.makedirs('_site', exist_ok=True)

          # Disable Jekyll processing
          with open('_site/.nojekyll', 'w') as f:
              f.write('')

          # Save HTML report
          with open('_site/index.html', 'w') as f:
              f.write(html)

          # Save summary for SMS
          summary = {
              'diveable': digest.diveable_sites,
              'total': digest.total_sites,
              'best_coast': digest.best_coast or 'Unknown',
              'top_sites': []
          }

          if digest.top_sites:
              for site in digest.top_sites[:3]:
                  summary['top_sites'].append({
                      'name': site.site.name,
                      'grade': site.grade,
                      'wpi': round(site.score.wave_power_index, 1) if site.score.wave_power_index else None
                  })

          with open('summary.json', 'w') as f:
              json.dump(summary, f)

          print(f'Generated report: {digest.diveable_sites}/{digest.total_sites} sites diveable')
          "

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          keep_files: false

      - name: Send Push Notification via ntfy.sh
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          # Only send if ntfy topic is configured
          if [ -z "$NTFY_TOPIC" ]; then
            echo "NTFY_TOPIC not configured, skipping notification"
            exit 0
          fi

          # Build notification message
          SUMMARY=$(cat summary.json)
          DIVEABLE=$(echo "$SUMMARY" | python -c "import sys,json; print(json.load(sys.stdin)['diveable'])")
          TOTAL=$(echo "$SUMMARY" | python -c "import sys,json; print(json.load(sys.stdin)['total'])")
          BEST_COAST=$(echo "$SUMMARY" | python -c "import sys,json; print(json.load(sys.stdin)['best_coast'])")
          TOP_SITE=$(echo "$SUMMARY" | python -c "import sys,json; s=json.load(sys.stdin)['top_sites']; print(f\"{s[0]['name']} ({s[0]['grade']})\" if s else 'None')")

          PAGES_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}/"

          # Send to ntfy.sh with action button
          curl -s \
            -H "Title: Dive Report: ${DIVEABLE}/${TOTAL} diveable" \
            -H "Priority: default" \
            -H "Tags: ocean,diving" \
            -H "Actions: view, View Full Report, ${PAGES_URL}" \
            -d "Best coast: ${BEST_COAST}
          Top site: ${TOP_SITE}" \
            "https://ntfy.sh/${NTFY_TOPIC}"

          echo "Notification sent to ntfy.sh/${NTFY_TOPIC}"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: dive-report-${{ github.run_number }}
          path: _site/index.html
          retention-days: 7
